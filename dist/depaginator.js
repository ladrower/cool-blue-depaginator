/*! cool-blue-depaginator v0.0.1 */
!function(a,b,c,d,e){"use strict";function f(a){this.$frame=a,this.rect=null,this.handler={scroll:i.proxy(this.onScroll,this),resize:i.proxy(this.onResize,this)},this.onThresholdReached=d,this.onFrameScrolled=d,this.onResized=d}function g(a,b){this.$context=a,this.selectors=new q(b),this.offsetTop=0,this.isBusy=!1,this._pages=[],this._onResetCb=[],this.init()}function h(a){this.worker=a,this.selectors=e,this.vpObserver=e,this.paging=e,this.isLoading=!1,this.loader=e,this.$header=e,this.$container=e,this.offsetTop=0,this.bindLazyLoadingImages=d,m.logV("constructed Depaginator:",this.worker.get("id"))}var i=b.jQuery,j=i(b),k=i(a),l=b[c],m=l.exports.util,n=l.exports.classes,o=n.Abstract.extend({attributes:{},constructor:function(a){var b=this;this.data={},i.each(this.attributes,function(c,d){b.data[c]=void 0!==a[c]?a[c]:d}),n.Abstract.apply(this,arguments)},set:function(a,b){this.data[a]=b},get:function(a){return this.data[a]}}),p=o.extend({attributes:{header:"",container:"",list:""}}),q=o.extend({attributes:{pagingHeader:"",pagingFooter:"",pages:"",current:"",next:"",prev:"",itemsPerPage:"",listItem:""}}),r=o.extend({attributes:{number:0,url:e,paging:null,nextUrl:e}});return f.prototype={turnOn:function(a,b,c){return this.isOn()&&this.turnOff(),l.cursor.request(this.handler),this.onThresholdReached=a||d,this.onFrameScrolled=b||d,this.onResized=c||d,this},turnOff:function(){return l.cursor.release(this.handler)&&(this.onThresholdReached=d,this.onFrameScrolled=d,this.onResized=d),this},isOn:function(){return!!l.cursor.findRequester(this.handler)},onScroll:function(a){this.observe(a),this.onFrameScrolled(this.rect.top)},onResize:function(a){this.observe(a),this.onResized()},observe:function(a){this.rect=this.$frame[0].getBoundingClientRect(),this.rect.bottom<1.5*a.vpH&&this.onThresholdReached()},trigger:function(){return i.each(this.handler,function(a){j.trigger(a)}),this}},g.POSITION={FIXED:"fixed",STATIC:"static"},g.prototype={getContainer:function(a){return(a||this.$context).find(this.selectors.get("pagingHeader")).first()},adjustDimensions:function(a){var b=this.getContainer().css({"float":"left",width:this.$context.width(),top:a});this.offsetTop=a,this.height=b.height()},bindEvents:function(){this.getContainer().find(this.selectors.get("pages")).on("click",i.proxy(this.onPageNumberClicked,this)),this.getContainer().find(this.selectors.get("next")).on("click",i.proxy(this.onPageNextClicked,this)),this.getContainer().find(this.selectors.get("prev")).on("click",i.proxy(this.onPagePrevClicked,this))},reposition:function(a){if(this.position!==a){var b=this.getContainer();switch(a){case g.POSITION.FIXED:this.$context.css({"padding-top":this.height});break;case g.POSITION.STATIC:this.$context.css({"padding-top":0});break;default:return}b.css("position",a),this.position=a}},updateCurrentPage:function(a){var c,e,f,g,h=this,i=0;!this.isBusy&&this._pages.length&&(f=this._pages[0],j.scrollTop()+j.height()===k.height()?i=this.getLast().get("number"):(e=f.get("number"),this.$context.find(this.selectors.get("listItem")).each(function(a,b){if(a&&a%h._itemsPerPage===0){if(c=Math.round(b.getBoundingClientRect().top),!(c<=h.height+h.offsetTop))return!1;i=e+a/h._itemsPerPage}})),g=i?this.getPage(i):f,this._currentPage!==g&&(this.getContainer().empty().append(g.get("paging").children().clone()),(b.history.pushState||d).call(b.history,null,null,g.get("url")),this.bindEvents(),this._currentPage=g))},toggleLoader:function(a){this.$loader.css("visibility",a?"visible":"hidden")},init:function(){var a=this.getContainer(),c=this.$context.find(this.selectors.get("itemsPerPage"));return a.css({"z-index":2,"background-color":"#fff"}),this.$loader=this.$context.find(this.selectors.get("pagingFooter")).empty().addClass("facet_loader_spinner_animation spinner-animation").css({position:"relative",visibility:"hidden"}).show(),this.position=e,this.height=a.height(),this._itemsPerPage=parseInt(c.val()),this._totalItems=parseInt(c.children().last().val()),this.reset(),this.collect(this.$context),this.get().set("url",b.location.toString()),this.bindEvents(),this},reset:function(){return this._pages.length=0,this._currentPage=null,this._index=0,i.each(this._onResetCb,function(a,b){b()}),this},subscribeOnReset:function(a){this._onResetCb.push(a)},get:function(){return this._pages[this._index]},getLast:function(){return this._pages[this._pages.length-1]},hasNext:function(){var a=this.get();return a&&a.get("nextUrl")},next:function(){return this._pages[++this._index]},collect:function(a){var b=a.find(this.selectors.get("next")),c=new r({number:1*a.find(this.selectors.get("current")).first().text(),paging:this.getContainer(a).clone()});return b.length&&c.set("nextUrl",b[0].href),this._pages.push(c),c},scrollToPage:function(a){var b=a?function(b){var c=b._pages.length?b._pages[0]:null;return c?b.$context.find(b.selectors.get("listItem")).eq((a-c.get("number"))*b._itemsPerPage).offset().top-b.height:0}(this):this.$context.offset().top;return i("html, body").animate({scrollTop:b-this.offsetTop},100).promise()},getPage:function(a){return i.grep(this._pages,function(b){return b.get("number")===a})[0]||null},onPageRequested:function(a){var b=this;return this.isBusy?!1:(this.isBusy=!0,null!==this.getPage(a)?(this.scrollToPage(a).then(function(){return b.isBusy=!1,this.trigger("scroll"),this}),!0):(this.position===g.POSITION.FIXED?this.scrollToPage(0).then(function(){b.reset(),b.isBusy=!1,this.trigger("scroll")}):this.isBusy=!1,!1))},onPageNumberClicked:function(a){return!this.onPageRequested(1*a.target.innerHTML)},onPageNextClicked:function(a){return!this.onPageRequested(this._currentPage?this._currentPage.get("number")+1:-1)},onPagePrevClicked:function(a){return!this.onPageRequested(this._currentPage?this._currentPage.get("number")-1:-1)}},h.prototype={init:function(a){return this.selectors=new p(a),this.$header=i(this.selectors.get("header")),this.$container=i(this.selectors.get("container")),this.updateOffsets(),this.paging=new g(this.$container,a),this.paging.subscribeOnReset(i.proxy(this.abort,this)),this.overrideNative(),this.paging.getContainer().length&&(this.vpObserver=new f(this.$container),this.vpObserver.turnOn(i.proxy(this.onRequestNextPage,this),i.proxy(this.onContainerScrolled,this),i.proxy(this.onViewportResized,this)).trigger()),this},abort:function(){this.loader&&(this.loader.reject(),this.loader=e)},overrideNative:function(){var a=this;this.bindLazyLoadingImages=b.bindLazyLoadingImages||d,b.bindLazyLoadingImages=function(){return a.onAfterPageReloaded(),a.bindLazyLoadingImages()}},reinitComparisonBar:function(){try{i(i.comparison.bar.defaultOptions.comparisonElementSelector+" input.checkbox").off("click"),k.off("click.comparisonbar"),i.comparison.bar(),i.comparison.collapse.activate()}catch(a){}},updateOffsets:function(){this.offsetTop=this.$header.height()},onContainerScrolled:function(a){this.paging.reposition(a-this.offsetTop<=0?g.POSITION.FIXED:g.POSITION.STATIC),this.paging.updateCurrentPage(a)},onViewportResized:function(){this.updateOffsets(),this.paging.adjustDimensions(this.offsetTop)},onRequestNextPage:function(){var a=this,b=this.selectors.get("list"),c=this.paging.get();this.isLoading||this.paging.hasNext()&&(this.isLoading=!0,this.paging.toggleLoader(!0),this.loader=new n.DfdLite,i.get(c.get("nextUrl")).then(i.proxy(a.loader.resolve,a.loader),i.proxy(a.loader.reject,a.loader)),this.loader.promise().done(function(d){var e=i(d);a.$container.find(b).append(e.find(b).children()),a.paging.collect(e),a.paging.next(),a.paging.get().set("url",c.get("nextUrl")),a.bindLazyLoadingImages(),m.async(a.reinitComparisonBar,a)}).always(function(){a.isLoading=!1,a.paging.toggleLoader(!1),a.vpObserver.trigger()}))},onAfterPageReloaded:function(){this.paging.init(),this.vpObserver.trigger()}},l.Depaginator=h}(document,window,window.__CoolblueNamespace__,function(){});